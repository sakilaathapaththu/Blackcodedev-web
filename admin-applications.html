<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Applications — Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; background:#0b0d17; color:#e8e8e8; }
    h1 { margin-bottom: 8px; }
    .bar { display:flex; gap:12px; align-items:center; margin: 12px 0 20px; flex-wrap: wrap; }
    input, button,textarea { padding:10px 12px; border-radius:8px; border:1px solid #2b2f3a; background:#121520; color:#e8e8e8; }
    input::placeholder { color:#9aa3b2; }
    button { cursor:pointer; }
    table { width:100%; border-collapse: collapse; overflow: auto; }
    th, td { border-bottom: 1px solid #2b2f3a; text-align:left; padding:10px; vertical-align: top; }
    th { background:#0f1320; position: sticky; top:0; }
    .muted { color:#9aa3b2; font-size: 12px; }
    .nowrap { white-space: nowrap; }
    .wrap { white-space: normal; }
    .pill { display:inline-block; padding:2px 8px; background:#1a2235; border:1px solid #2b2f3a; border-radius:12px; font-size:12px; }
    a { color:#7fb2ff; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .empty { padding: 18px; border:1px dashed #2b2f3a; border-radius:12px; text-align:center; color:#9aa3b2; }
  </style>
</head>
<body>
  <h1>Applications</h1>
  <div class="muted">Admin view of job applications. Use the API key to load data and download CVs.</div>

  <div class="bar">
    <input id="apiBase" type="text" placeholder="API Base (e.g. http://localhost:4000)" style="min-width:280px" />
    <input id="apiKey" type="password" placeholder="x-api-key (admin)" style="min-width:240px" />
    <input id="q" type="text" placeholder="Search name/email/position…" style="min-width:260px" />
    <button id="loadBtn">Load</button>
    <button id="addCareerBtn">Add Career</button> 
    <button id="viewJobsBtn">View Careers</button>
  </div>

  <div id="content"></div>
  <div id="jobsContent" style="margin-top:16px;"></div>

  <!-- Add Career Modal -->
  <div id="careerModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:#121520; padding:20px; border-radius:12px; width:500px; max-width:95%;">
      <h2 style="margin-top:0;">Add Career</h2>
      <form id="careerForm" style="display:flex; flex-direction:column; gap:12px;">
        <input type="text" id="jobTitle" placeholder="Job Title" required />
        <input type="text" id="jobDept" placeholder="Department" required />
        <input type="text" id="jobLoc" placeholder="Location" required />
        <textarea id="jobDesc" placeholder="Description" required></textarea>
        <textarea id="jobReqs" placeholder="Requirements (one per line)" required></textarea>
        <div style="display:flex; justify-content:flex-end; gap:10px;">
          <button type="button" onclick="closeCareerModal()">Cancel</button>
          <button type="submit">Save</button>
        </div>
      </form>
      <div id="careerMsg" class="muted" style="margin-top:10px;"></div>
    </div>
  </div>

  <!-- Edit Career Modal -->
  <div id="editCareerModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:#121520; padding:20px; border-radius:12px; width:500px; max-width:95%;">
      <h2 style="margin-top:0;">Edit Career</h2>
      <form id="editCareerForm" style="display:flex; flex-direction:column; gap:12px;">
        <input type="hidden" id="editJobId" />
        <input type="text" id="editJobTitle" placeholder="Job Title" required />
        <input type="text" id="editJobDept" placeholder="Department" required />
        <input type="text" id="editJobLoc" placeholder="Location" required />
        <textarea id="editJobDesc" placeholder="Description" required></textarea>
        <textarea id="editJobReqs" placeholder="Requirements (one per line)" required></textarea>
        <div style="display:flex; justify-content:flex-end; gap:10px;">
          <button type="button" onclick="closeEditCareerModal()">Cancel</button>
          <button type="submit">Update</button>
        </div>
      </form>
      <div id="editCareerMsg" class="muted" style="margin-top:10px;"></div>
    </div>
  </div>

  <script>
    const state = { apps: [], filtered: [] };

    function esc(s = '') {
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    function fmtDate(d) {
      try { return new Date(d).toLocaleString(); } catch { return d || ''; }
    }

    async function load() {
      const base = document.getElementById('apiBase').value.trim() || 'http://localhost:4000';
      const key  = document.getElementById('apiKey').value.trim();

      if (!key) {
        alert('Please enter your admin x-api-key.');
        return;
      }

      const content = document.getElementById('content');
      content.innerHTML = '<div class="empty">Loading…</div>';

      try {
        const res = await fetch(`${base}/api/applications`, { headers: { 'x-api-key': key } });
        if (!res.ok) throw new Error(`Failed (${res.status})`);
        const data = await res.json();

        state.apps = Array.isArray(data) ? data : [];
        state.filtered = state.apps.slice();
        render(base);
      } catch (e) {
        console.error(e);
        content.innerHTML = `<div class="empty">Could not load applications. Check API base and key.</div>`;
      }
    }

    function filter() {
      const q = document.getElementById('q').value.trim().toLowerCase();
      if (!q) {
        state.filtered = state.apps.slice();
      } else {
        state.filtered = state.apps.filter(a => {
          const job = a.jobId && a.jobId.title ? a.jobId.title : a.position || '';
          const hay = [a.fullName, a.email, a.phone, a.description, job]
            .map(x => (x || '').toLowerCase()).join(' ');
          return hay.includes(q);
        });
      }
      const base = document.getElementById('apiBase').value.trim() || 'http://localhost:4000';
      render(base);
    }

    function render(apiBase) {
      const content = document.getElementById('content');
      if (!state.filtered.length) {
        content.innerHTML = `<div class="empty">No applications found.</div>`;
        return;
      }

      const rows = state.filtered.map(a => {
        const jobTitle = a.jobId && a.jobId.title ? a.jobId.title : (a.position || '—');

        // Prefer cvUrl (Vercel Blob). Fallback to /uploads/cvFilename for legacy/local files.
        const cvUrl = a.cvUrl
          ? a.cvUrl
          : (a.cvFilename ? `${apiBase}/uploads/${encodeURIComponent(a.cvFilename)}` : '');

        const cvCell = cvUrl
          ? `<a href="${cvUrl}" target="_blank" rel="noopener noreferrer">Download CV</a>`
          : '<span class="muted">No file</span>';

        return `
          <tr>
            <td class="nowrap">${esc(fmtDate(a.createdAt))}</td>
            <td class="wrap">
              <div><strong>${esc(jobTitle)}</strong></div>
              <div class="muted">${esc(a.jobId?._id || a.jobId || '')}</div>
            </td>
            <td class="wrap">
              <div><span class="pill">${esc(a.fullName || '')}</span></div>
              <div class="muted">
                ${a.email ? `<a href="mailto:${esc(a.email)}">${esc(a.email)}</a>` : ''}
                ${a.phone ? (a.email ? ' · ' : '') + esc(a.phone) : ''}
              </div>
            </td>
            <td class="wrap">${esc(a.description || '')}</td>
            <td class="nowrap">${cvCell}</td>
          </tr>
        `;
      }).join('');

      content.innerHTML = `
        <div style="overflow:auto; border:1px solid #2b2f3a; border-radius: 12px;">
          <table>
            <thead>
              <tr>
                <th class="nowrap">Submitted</th>
                <th>Position</th>
                <th>Applicant</th>
                <th>Message</th>
                <th>CV</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;
    }

    document.getElementById('loadBtn').addEventListener('click', load);
    document.getElementById('q').addEventListener('input', filter);

    // default for your deploy
    document.getElementById('apiBase').value = 'http://localhost:4000';

    // ===== Add Career modal logic =====
    const modal = document.getElementById('careerModal');
    const form = document.getElementById('careerForm');
    const msg = document.getElementById('careerMsg');

    document.getElementById('addCareerBtn').addEventListener('click', () => {
      modal.style.display = 'flex';
      msg.textContent = '';
      form.reset();
    });

    function closeCareerModal() {
      modal.style.display = 'none';
    }
    window.closeCareerModal = closeCareerModal;

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.textContent = 'Saving...';

      const base = document.getElementById('apiBase').value.trim();
      const key  = document.getElementById('apiKey').value.trim();

      if (!key) {
        msg.textContent = 'Missing admin x-api-key.';
        return;
      }

      const payload = {
        title: document.getElementById('jobTitle').value,
        department: document.getElementById('jobDept').value,
        location: document.getElementById('jobLoc').value,
        description: document.getElementById('jobDesc').value,
        requirements: document.getElementById('jobReqs').value.split('\n').map(r => r.trim()).filter(Boolean)
      };

      try {
        const res = await fetch(`${base}/api/jobs/add`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': key
          },
          body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error(`Failed (${res.status})`);
        msg.textContent = 'Career added successfully ✅';
        form.reset();
        maybeRefreshJobs();
      } catch (err) {
        console.error(err);
        msg.textContent = 'Error adding career ❌';
      }
    });

    // ===== VIEW / TOGGLE / EDIT CAREERS =====
    const jobsContent = document.getElementById('jobsContent');

    async function loadJobs() {
      const base = document.getElementById('apiBase').value.trim() || 'http://localhost:4000';
      const key  = document.getElementById('apiKey').value.trim();

      if (!key) {
        jobsContent.innerHTML = '<div class="empty">Enter your admin x-api-key, then click "View Careers".</div>';
        return;
      }

      jobsContent.innerHTML = '<div class="empty">Loading careers…</div>';

      try {
        const res = await fetch(`${base}/api/jobs/all`, { headers: { 'x-api-key': key } });
        if (!res.ok) throw new Error(`Failed (${res.status})`);
        const jobs = await res.json();

        if (!Array.isArray(jobs) || jobs.length === 0) {
          jobsContent.innerHTML = '<div class="empty">No careers found.</div>';
          return;
        }

        const rows = jobs.map(j => {
          const isActive = j.active !== false;
          const nextState = !isActive;
          const btnLabel  = isActive ? 'Disable' : 'Enable';
          const status    = isActive ? 'Active' : 'Inactive';

          return `
            <tr>
              <td class="wrap"><strong>${esc(j.title || '')}</strong></td>
              <td class="nowrap">${esc(j.department || '')}</td>
              <td class="nowrap">${esc(j.location || '')}</td>
              <td class="nowrap">${esc(j.createdAt ? new Date(j.createdAt).toLocaleString() : '')}</td>
              <td class="nowrap"><span class="pill">${status}</span></td>
              <td class="nowrap">
                <button
                  class="toggle-active"
                  data-id="${esc(j._id || '')}"
                  data-next="${nextState}"
                >${btnLabel}</button>
                <button
                  class="edit-job"
                  data-id="${esc(j._id || '')}"
                  data-title="${esc(j.title || '')}"
                  data-dept="${esc(j.department || '')}"
                  data-loc="${esc(j.location || '')}"
                  data-desc="${esc(j.description || '')}"
                  data-reqs="${esc((j.requirements || []).join('\n'))}"
                >Edit</button>
              </td>
            </tr>
          `;
        }).join('');

        jobsContent.innerHTML = `
          <div style="overflow:auto; border:1px solid #2b2f3a; border-radius:12px;">
            <table>
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Department</th>
                  <th>Location</th>
                  <th class="nowrap">Created</th>
                  <th class="nowrap">Status</th>
                  <th class="nowrap">Actions</th>
                </tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        `;

        bindToggleButtons();
        bindEditButtons();
      } catch (e) {
        console.error(e);
        jobsContent.innerHTML = '<div class="empty">Could not load careers.</div>';
      }
    }

    async function toggleJobActive(jobId, nextActive) {
      const base = document.getElementById('apiBase').value.trim() || 'http://localhost:4000';
      const key  = document.getElementById('apiKey').value.trim();

      if (!key) {
        alert('Enter your admin x-api-key to change status.');
        return;
      }

      try {
        const res = await fetch(`${base}/api/jobs/${jobId}/active`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json', 'x-api-key': key },
          body: JSON.stringify({ active: Boolean(nextActive) })
        });
        if (!res.ok) throw new Error(`Failed (${res.status})`);
        await loadJobs();
      } catch (e) {
        console.error(e);
        alert('Could not update status.');
      }
    }

    function bindToggleButtons() {
      document.querySelectorAll('.toggle-active').forEach(btn => {
        btn.addEventListener('click', () => {
          const id   = btn.getAttribute('data-id');
          const next = btn.getAttribute('data-next') === 'true';
          toggleJobActive(id, next);
        });
      });
    }

    // ====== Edit Modal logic ======
    const editModal = document.getElementById('editCareerModal');
    const editForm  = document.getElementById('editCareerForm');
    const editMsg   = document.getElementById('editCareerMsg');

    function openEditCareerModal(job) {
      document.getElementById('editJobId').value    = job.id;
      document.getElementById('editJobTitle').value = job.title;
      document.getElementById('editJobDept').value  = job.dept;
      document.getElementById('editJobLoc').value   = job.loc;
      document.getElementById('editJobDesc').value  = job.desc;
      document.getElementById('editJobReqs').value  = job.reqs;
      editMsg.textContent = '';
      editModal.style.display = 'flex';
    }

    function closeEditCareerModal() {
      editModal.style.display = 'none';
    }
    window.closeEditCareerModal = closeEditCareerModal;

    function bindEditButtons() {
      document.querySelectorAll('.edit-job').forEach(btn => {
        btn.addEventListener('click', () => {
          openEditCareerModal({
            id:   btn.getAttribute('data-id'),
            title: btn.getAttribute('data-title'),
            dept:  btn.getAttribute('data-dept'),
            loc:   btn.getAttribute('data-loc'),
            desc:  btn.getAttribute('data-desc'),
            reqs:  btn.getAttribute('data-reqs')
          });
        });
      });
    }

    editForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const base = document.getElementById('apiBase').value.trim();
      const key  = document.getElementById('apiKey').value.trim();
      const id   = document.getElementById('editJobId').value;

      const payload = {
        title: document.getElementById('editJobTitle').value,
        department: document.getElementById('editJobDept').value,
        location: document.getElementById('editJobLoc').value,
        description: document.getElementById('editJobDesc').value,
        requirements: document.getElementById('editJobReqs').value.split('\n').map(r => r.trim()).filter(Boolean)
      };

      if (!key) { editMsg.textContent = 'Missing admin x-api-key.'; return; }

      editMsg.textContent = 'Updating…';
      try {
        const res = await fetch(`${base}/api/jobs/${encodeURIComponent(id)}`, {
          method: 'PATCH',
          headers: { 'Content-Type':'application/json','x-api-key':key },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error(`Failed (${res.status})`);
        editMsg.textContent = 'Career updated ✅';
        closeEditCareerModal();
        loadJobs();
      } catch (err) {
        console.error(err);
        editMsg.textContent = 'Update failed ❌';
      }
    });

    // Button: View Careers
    document.getElementById('viewJobsBtn').addEventListener('click', loadJobs);

    // After adding a career, refresh list if it's visible
    const maybeRefreshJobs = () => {
      if (jobsContent && jobsContent.innerHTML && !/No careers found|Loading careers/.test(jobsContent.textContent)) {
        loadJobs();
      }
    };
  </script>
</body>
</html>
